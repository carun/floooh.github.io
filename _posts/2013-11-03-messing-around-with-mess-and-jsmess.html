---
layout: post
title: Messing around with MESS (and JSMESS)
date: '2013-11-03T16:11:00.001+01:00'
author: Andre Weissflog
tags: 
modified_time: '2013-11-03T16:11:44.717+01:00'
thumbnail: https://lh5.googleusercontent.com/-MN0rKIcuB-E/UnZRyi0UYBI/AAAAAAAAATY/a47ECHlNujA/s72-c/kc85_3.png
blogger_id: tag:blogger.com,1999:blog-2948438400037317662.post-3329851576295955112
blogger_orig_url: http://flohofwoe.blogspot.com/2013/11/messing-around-with-mess-and-jsmess.html
---

<p>And now for something completely different:</p> <p>Since I’m dabbling with emscripten I’ve had this idea in my head to write or port a <a href="http://en.wikipedia.org/wiki/KC85">KC85/3</a> emulator, so that I could play the games I wrote as a kid directly in the browser. The existing KC85 emulators I was aware of are not trival to port, they either depend on x86 inline assembly, or are hardwired to a specific UI framework (if you read German, here’s an overview on what’s out there: <a href="http://www.kc85emu.de/Emulatoren/Emulatoren.htm">http://www.kc85emu.de/Emulatoren/Emulatoren.htm</a> )</p> <p>About 2 weeks ago I started to look around more seriously for a little side project to spent my 3 weeks of vacation around Christmas (I need to burn my remaining vacation days, in Germany employees are basically required by law to take all their vacation - tough shit ;) My original plan was to cobble together a minimal emulator just enough to run my old games: Take an existing Z80 CPU emulator like the one from <a href="http://fuse-emulator.sourceforge.net/">FUSE</a>, hack some keyboard input and video output and go on from there.</p> <p>Thankfully I then had a closer look at <a href="http://www.mess.org/">MESS</a>. I always thought that MESS could only emulate the most popular Western game machines like the C64 or Atari 400, but it turns out that this beast can emulate pretty much any computer that ever existed (between 600 and 1700, depending on how you count), it even has support for the PDP-1 from the early 60’s! When searching through the list of emulated systems here (<a href="http://www.progettoemma.net/mess/sysset.php">http://www.progettoemma.net/mess/sysset.php</a>) I stumbled over the following entries: </p> <ul><li>HC900 / KC 85/2</li><li>KC 85/3</li><li>KC 85/4</li><li>KC Compact</li><li>Lerncomputer LC 80</li><li>KC 85/1</li><li>Z1013</li><li>Poly-Computer 880</li><li>BIC A5105</li></ul> <p>That’s the entire list of East-German “hobby computers”. But wait, there’s more:</p> <ul><li>Robotron PC-1715</li><li>A5120</li><li>A7150</li></ul> <p>These were GDR office computers. The 1715 was a CP/M compatible 8-bit PC, and the A7150 was a not-quite-compatible x86 IBM-PC clone. I’m actually not sure what the 5120 was, just that it was a big ugly box with built-in mono-chrome monitor.</p> <p>Since all those systems are marked as “not working” in this list I wasn’t too enthusiastic yet, but I had to be sure. The latest MESS compiled out of the box on OSX, and it was easy to find the right ROM images in the net. So I started MESS with:</p> <blockquote>  <p>./mess64 kc85_3 -window</p></blockquote> <p>To my astonishment I watched a complete boot sequence into the operating system:</p> <p><img src="https://lh5.googleusercontent.com/-MN0rKIcuB-E/UnZRyi0UYBI/AAAAAAAAATY/a47ECHlNujA/s640/kc85_3.png" alt="KC85/3 system shell" title="kc85_3.png"></p> <p>Excite!</p> <p>I also came across the <a href="https://github.com/jsmess/jsmess">JSMESS</a> project before, which is a port of MESS to Javascript using emscripten. So my next step was to compile JSMESS and see whether the KC emulator works there as well. It booted, but didn’t accept any keyboard input :( After comparing the source code it dawned on me that JSMESS was far behind MESS, about 2 years to be exact. But this was a good excuse to dive a bit deeper into how MESS actually works, and the deeper I crawled the more impressed I became.</p> <p>MESS had been derived from the well known MAME arcade machine emulator project, with the goal to extend the emulation to “real computers”. Later MESS merged with MAME again, so that today both projects compile from the same code base. </p> <p>A specific emulated machine is called a “system driver” and can be described by just a few lines of code listing what CPU to use, the RAM and ROM areas, what ROM image to load, and what memory-mapped IO registers exist. You’ll also have to provide several callback routines for handling reads and write to IO addresses and to convert the system’s video memory into a standardized bitmap representation. For a very simple computer built from standard chips a working emulator can be plugged together in a couple of hours, but writing a complete and “cycle-perfect” emulator is of course still a tough challenge, especially if custom chips are used. The overall amount of research and implementation work that went into MESS is almost overwhelming. Pretty much every computer, every mass-produced chip that ever existed is emulated in there, often with all of their undocumented quirks!</p> <p>Ok, back to the KC85/3: after analyzing the source code of the KC driver it quickly became clear that the keyboard input emulation was the toughest part, since this was where the original KC engineers were very “creative”. As far as I understood the several pages of email exchange which are included as comment in the MESS KC driver, the KC keyboard used a very exotic TV remote control chip to send serial pulses to the main unit (the KC had an external keyboard connected with a “very thin” wire, so it was very likely a simple serial connection). The base unit which received the signal didn’t have a “decoder chip” however, but used its universal Z80-CTC (timer) and -PIO (in/out) chips to decode the signal. Emulating this behaviour seems to be very tricky since a lot of KC emulators have yanky keyboard input (not registering key presses, or inserting random key codes when typing fast, etc…). </p> <p>Since I didn’t get this to work reliably even after back-porting the latest keyboard input code from MESS (which somewhat works, but still has problems with random keys triggering), I decided to be a bit naughty and implement a shortcut (the “cycle-perfect” emulator purists will likely kill me for this heresy):</p> <p>After the KC-ROM reads a keyboard scan-code through this tricky serial-pulse decoding described above, it converts the scan code to ASCII and writes it to memory location 0x1FD, and then sets bit 0 in memory location 0x1F8 to signal that a new key code is available. It also maintains a keyboard repeat counter in address 0x1FA. All of this can be gathered from the keyboard handling code in ROM (and is also explained in that very informative, very long comment in the source code). I’m basically “shortcutting” this with C code and write the ASCII code directly to 0x1FD and also handle the key repeat directly in C. The tricky serial decoding stuff in ROM is never triggered this way. With this hack the keyboard input is fairly responsive (sometimes the first key is swallowed, don’t know yet what’s up with this).</p> <p>Next I had to fix the RGB colors which were off both in MESS and JSMESS (bright yellow-green looked more like puke-yellowish, and all other “inbetween colors” were off too), and I finally back-ported (and also optimized a bit) the video memory mapping code from MESS to JSMESS.</p> <p>You can check all my changes here on GitHub: <a href="https://github.com/floooh/jsmess/tree/floh">https://github.com/floooh/jsmess/tree/floh</a> Right now a “reboot” is going on in the JSMESS project to bring it uptodate with the latest MESS version. I’ll wait with any pull-requests until this is finished and I refreshed my own fork as well. Also I will not try to contribute my “dirty hacks” back to the main code base of course, the MESS guys are right to insist on perfect emulation instead of shortcut hacks like the keyboard hack described above. But my (rather egoistic) main goal is to get my own games running on my web page, so I think I can get away with such hacks in my own fork.</p> <p>The next challenge is to get all of my games running in JSMESS. This is harder than I thought. Part of the problem is that there exist several memory dump files which are not original. I found dump files with the wrong entry address, and dumps where others have implemented cheats and trainers. So far I’ve got 3 out of 7 games working. Getting the remaining 4 games into working condition might take a while since I may have to do some hardcore assembly debugging to find out what’s wrong.</p> <p>Thankfully MESS has a completely assembler-level debugger built-in:</p> <p><img src="https://lh4.googleusercontent.com/-cGvLLPa3ECQ/UnZdCMaNbkI/AAAAAAAAATs/S9zmgnM3j1c/s640/mess_debugger.png" alt="MESS Debugger" title="mess_debugger.png"></p> <p>Re-constructing the program flow of this 25-year-old game which I wrote in machine code (instead of using a assembler) is actually quite a lot of fun, much easier than trying to reconstruct a program which was written in a high-level language and compiled to machine code. Subroutines often start at “even” addresses, and have a block of NOP instructions appended, in case I needed to add instructions when fixing bugs, strings are usually embedded right into the instruction sequence instead of a central “string pool”. Analyzing the program flow comes down to figuring out what a given subroutine does (drawing a sprite? handling keyboard input? updating the hiscore display?), and what variables are stored at specific memory addresses (for instance current live counter, current position, and so on).</p> <p>What’s remarkable is how small the game code actually is, even though it is not very dense with all those NOPs inbetween and a lot of redundant code segments (e.g. I didn’t specifically care about code size). Of the about 12kByte of my (very simple) Pacman clone, only about 3.5 kByte are actual code. The entire game code fits on a single screen (marked in yellow here):</p> <p><img src="https://lh3.googleusercontent.com/-M57TfxuhUW0/UnZf7V4L43I/AAAAAAAAAT8/Fb3Q0s8opNQ/s640/pacman_dump.png" alt="enter image description here" title="pacman_dump.png"></p> <p>Finally, here’s the current result of this work: a JSMESS KC85/3 and KC85/4 emulator, and 3 of my old games running directly in the browser. Don’t try this on an iPhone though (or generally Safari). Firefox or an uptodate Chrome works very well:</p> <p><a href="http://www.flohofwoe.net/history.html">http://www.flohofwoe.net/history.html</a></p> <blockquote>  <p>Written with <a href="https://stackedit.io/">StackEdit</a>.</p></blockquote>