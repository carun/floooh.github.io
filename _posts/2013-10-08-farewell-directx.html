---
layout: post
title: Farewell DirectX
date: '2013-10-08T21:04:00.001+01:00'
author: Andre Weissflog
tags: 
modified_time: '2013-10-08T21:17:01.844+01:00'
thumbnail: https://lh4.googleusercontent.com/-DMWhzCDd3Sc/UlRc0YsK2VI/AAAAAAAAASY/nSP1wW8hoRU/s72-c/cg2_win32.png
blogger_id: tag:blogger.com,1999:blog-2948438400037317662.post-6251257632972197982
blogger_orig_url: http://flohofwoe.blogspot.com/2013/10/farewell-directx.html
---

<p>Today I ported the OpenGL rendering code in Nebula3's bleeding edge branch back to Windows:</p> <p><img src="https://lh4.googleusercontent.com/-DMWhzCDd3Sc/UlRc0YsK2VI/AAAAAAAAASY/nSP1wW8hoRU/s480/cg2_win32.png" alt="enter image description here" title="Windows version of N3 running in OpenGL"></p> <p>This is remarkable in 2 ways:</p> <ol><li>It's the first time since around 1997 that I ported a significant amount of code <em>to</em> Windows. Usually it was from Windows towards another platform.</li><li>This is also the end of DirectX in our code base (well almost, we're still using the xnamath.h header, which is a standalone header and doesn't require linking against any DX DLL).</li></ol> <p>Why do I think that this is remarkable:</p> <p>It is the end of an era! In 1997 I ported Urban Assault from DOS to Windows95 and Direct3D5. This was just around the time when Windows started its career as a gaming platform. D3D5 was the first D3D version which didn't completely suck because it had the new DrawPrimitive API, before that, rendering commands had to be issued through an incredibly arcane "execute buffer" concept (theoretically a good idea if GPUs would have been able to directly parse this buffer, but terrible to use in real-world code). The Urban Assault port to D3D was pretty inefficient since we ported from a software rasterizer (with perspective correction and all that cool shit), and if I remember correctly we issued every single triangle through a single DrawPrimitive call (although that wasn't such a big deal at the time). And the only graphics card which had somewhat acceptable D3D support was the RIVA128 from an underdog company called nVidia (this was before their breakthrough TNT2), and the top dog was the 3dfx Voodoo2 which had much better support for Glide then for D3D. But since UA was published by Microsoft we had to be D3D-exclusive of course.</p> <p>Since 1998 Direct3D was our primary rendering API, I dabbled around with OpenGL from time to time, but nothing serious. We made the jump to D3D7, D3D8, and finally D3D9. Each new version sucked less and less, and D3D9 is still a really good API. We never made the jump to D3D10 because of Microsoft's exceptionally stupid decision to not back-port D3D10 to Windows XP from Vista, and since Nebula was never about high-end rendering features but instead running on a broad range of old hardware we could never justify to add D3D10 support, since we couldn't give up D3D9.</p> <p>And as silly as it sounds, this boneheaded Microsoft decision from 7 years ago is one important reason why I'm ditching D3D today. World-wide, WindowsXP is the <em>fastest growing</em> Windows version. It's growing a lot faster than Windows8. Don't believe me? See the Unity hardware stats page for a scary reality check:</p> <p><a href="http://stats.unity3d.com/web/index.html">http://stats.unity3d.com/web/index.html</a></p> <p>The Chinese Dragon has awoken, and it is running exclusively on XP. WindowsXP is also very popular in Eastern Europe and the Middle East. So if you want to support markets east and south of Middle Europe you're basically fucked if you don't support XP.</p> <p>Another important reason is streamlining the code base. The currently "interesting platforms" (browser and mobile) are all running some variant of POSIX+OpenGL. In this new world the Windows APIs are the exotics, and Microsoft doesn't exactly help the cause by repeating their errors of the past (limiting Windows Store apps to D3D11). By using a single rendering code base (and especially shader code base!) across all platforms we're reducing our technical debt in the future.</p> <p>I have a fallback plan of course, because there are a few risks:</p> <ul><li>What if OpenGL driver quality on Windows is as bad as everybody says?</li><li>What if we need to support native Windows Store apps (as opposed to a WebGL version running embedded in a browser)?</li></ul> <p>The fallback plan has 2 stages:</p> <ol><li>Use <a href="https://code.google.com/p/angleproject">ANGLE</a> which layers OpenGL ES2 with some important extensions over D3D9 or D3D11, this is the preferred solution since we don't need to touch the render layer code and shader library.</li><li>If ANGLE isn't good enough, write native D3D9 and D3D11 ports of the CoreGraphics2 subsystem, and optimally use some API agnostic shader language wrapper. This wouldn't be as bad as it sounds, each wrapper would have around 7k lines of code, which is about 4.5% of Nebula3 in its minimal useful configuration (which is about 150k lines of code, depending on which other N3 modules are added this can go up to 500k lines of code).</li></ol> <p>OpenGL isn't perfect of course. It has some incredibly crufty corners, most of those have been fixed in through extensions and newer GL versions over time, but realistically we can't use anything newer then OpenGL ES2 with very few extensions for the renderer's base feature set.</p> <p>When I removed the DirectX library stubs from the Nebula3 CMake files this afternoon I really had to stop and think for a moment. Who knows, maybe in a future blog post in about 15 years I will write "this was around the time when Windows became irrelevant as a gaming platform"? ;)</p> <blockquote>  <p>Written with <a href="http://benweet.github.io/stackedit/">StackEdit</a>.</p></blockquote>