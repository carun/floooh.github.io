---
layout: post
title: A Drakensang Online map viewer in emscripten
date: '2013-01-19T18:36:00.001+01:00'
author: Andre Weissflog
tags: 
modified_time: '2013-01-23T21:16:10.822+01:00'
thumbnail: http://2.bp.blogspot.com/-ULUN7jnD2mY/UPq8SFLgx0I/AAAAAAAAAQQ/ECPtksc-rEc/s72-c/dsomapviewer.png
blogger_id: tag:blogger.com,1999:blog-2948438400037317662.post-2480302758964958957
blogger_orig_url: http://flohofwoe.blogspot.com/2013/01/a-drakensang-online-map-viewer-in.html
---

<b>Update 2: </b>The OSX/Radeon performance problem should be fixed now. See here:&nbsp;<a href="http://flohofwoe.blogspot.de/2013/01/a-radeon-fix-and-more.html" target="_blank">http://flohofwoe.blogspot.de/2013/01/a-radeon-fix-and-more.html</a><br /><b><br /></b><b>Update: </b>Just found out that the demo runs incredibly slow on a 15"Mac when running on the discrete AMD Radeon HD 6770M chip (it's actually much faster on the integrated Intel HD 3000). This is both on Chrome and Firefox, reason unknown yet. So if you have one of these, note that the demo runs actually a lot smoother ;)<br /><br />I did a very simple proof-of-concept Drakensang Online map viewer in Nebula3/emscripten (as always, Chrome or Firefox required), to see how JS+WebGL can deal with a close-to-real-world 3D scenario:<br /><div><br /></div><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><span style="margin-left: auto; margin-right: auto;"><a href="http://n3emscripten.appspot.com/dsomapviewer.html" target="_blank"><img border="0" height="324" src="http://2.bp.blogspot.com/-ULUN7jnD2mY/UPq8SFLgx0I/AAAAAAAAAQQ/ECPtksc-rEc/s640/dsomapviewer.png" width="640" /></a></span></td></tr><tr><td class="tr-caption" style="text-align: center;"><a href="http://n3emscripten.appspot.com/dsomapviewer.html" target="_blank">Drakensang Online map viewer</a></td></tr></tbody></table>This is work in progress and I will spend more time with optimizations before moving on to the next demo.<br /><div><br /></div><div>You'll notice that there's still frame-rate-stuttering when moving around the map (with left-mouse-button&nbsp;+ dragging). The bad type of stuttering is caused by asset loading which happens on demand when new graphics objects are pulled in as they enter the view volume. I don't know yet what causes the lighter stuttering when moving around in areas which are completed loaded. I need to do a detailed profiling session to figure out what's going on there exactly. The stuttering also happens (to a lesser extend) in the native OSX version of the demo. It's most likely the preparation and creation of OpenGL resources, like vertex buffer, index buffers and textures. I will need to figure out how to move more of the asset creation stuff out of the main thread.<br /><div><br /></div><div>The demo is also quite demanding on WebGL. Despite the pseudo-instancing which I implemented recently there's still a lot of OpenGL calls per frame. Support for the&nbsp;<b>OES_vertex_array_object</b>&nbsp;(Chrome already exposes this) and something like <b>ARB_instanced_arrays</b> would help a lot to reduce the number of GL calls drastically (the JS profiler currently shows the vertex array definition as the most expensive rendering-related code, followed by the matrix array uniform updates for the pseudo instancing code).</div><div><br /></div><div>Finally I've added a new Nebula3 code module to this demo: the ODE-based physics and collision subsystem is now also running in emscripten (no changes were necessary), the demo sets up a static collide world at startup and uses this to perform stabbing checks under the mouse pointer. Unfortunately adding ODE almost doubled the size the of the generated Javascript code. This is another incentive to finally get rid of our (somewhat bloated) physics wrapper code and ODE, and build a new slim collision system, probably on top of the Bullet collision classes (we're mainly using the current physics wrapper for simple collision checks on a static collide world in the live version of Drakensang Online, so not much of value will be lost).</div><div><br /></div><div>Also, originally I wanted to include SQLite into the demo, since additional map info is currently stored in an additional SQLite file (lighting information, player start position, etc...). But this didn't work out of the box because SQLite's file i/o code must be adopted.</div><div><br /></div><div>This wouldn't be hard to fix, but I actually want to get rid of SQLite for a long time. SQLite was really useful as save-game system in the single player Drakensang games, but if you don't need to save game world changes back, a complete SQL implementation in the client is just overkill. So this is another good reason to finally get started with a nice and small TableData-subsystem in Nebula3.</div><div><br /></div><div>The frame-stuttering is a tiny bit disheartening, but on the other hand this is to be expected when bringing a complex code base over to a new platform. Most important right now is to really know what's going on, so I will probably spend some time adding profiling code and do some performance analysis next - together with text rendering to get some continuous debug statistics output on screen.</div><div><br />Exciting stuff :D</div><div><br /></div></div>